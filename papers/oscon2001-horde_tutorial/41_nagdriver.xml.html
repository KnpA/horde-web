<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>Presentations :: Nag SQL Storage</title>
<link href="presentation.css" rel="stylesheet" type="text/css" />
</head>

<body>
<table class='oratorHeader' border='0' cellspacing='0' cellpadding='1' width='100%'><tr>
<td width='1%' align='left' class='oratorHeaderBack' valign='center' nowrap='nowrap'><a href="40_subclass.xml.html" onmouseout="status='';" onmouseover="status='Go to Subclasses'; return true;"><img src="presentation_back.gif" border="0" alt="" /></a></td><td style="cursor: hand;" onclick="location.href='40_subclass.xml.html';" align="left" class="oratorHeaderBack" width="24%"><table border="0" cellspacing="0" cellpadding="0"><tr><td nowrap="nowrap"><div class='oratorTitleHigh'>Subclasses</div></td></tr></table></td>
<td width='50%' align='center' class='oratorHeaderBack' valign='center' nowrap='nowrap'><table border="0" cellspacing="0" cellpadding="0"><tr><td nowrap="nowrap"><div class='oratorTitle'>Nag SQL Storage</div></td></tr></table></td>
<td style='cursor: hand;' onclick='location.href="42_templates.xml.html";' width='24%' align='right' class='oratorHeaderBack' valign='center' nowrap='nowrap'><table border="0" cellspacing="0" cellpadding="0"><tr><td nowrap="nowrap"><div class='oratorTitleHigh'>Templates</div></td></tr></table></td><td width="1%" align="right"><a href="42_templates.xml.html" onmouseout="status='';" onmouseover="status='Go to Templates'; return true;"><img src="presentation_forward.gif" border="0" alt="" /></a></td>
</tr></table>
<br /><br /><div align='center'>
<table border='0' width='600'><tr><td align='left'>

<p>
Nag's SQL Storage implementation
</p>
<code><font color="#000000">
<font color="#0000BB">&lt;?php<br></font><font color="#FF8000">// $Horde: hordeweb/papers/oscon2001-horde_tutorial/41_nagdriver.xml.html,v 1.1 2001/12/05 16:48:07 chuck Exp $<br><br>/**<br> * Nag storage implementation for PHP's PEAR database abstraction layer.<br> *<br> * Required values for $params:<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'phptype'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The database type (e.g. 'pgsql', 'mysql, etc.).<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'hostspec'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The hostname of the database server.<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'protocol'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The communication protocol ('tcp', 'unix', etc.).<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'username'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The username with which to connect to the database.<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'password'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The password associated with 'username'.<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'database'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The name of the database.<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'table'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The name of the preferences table in 'database'.<br> * <br> * Required by some database implementations:<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'options'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Additional options to pass to the database.<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'tty'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The TTY on which to connect to the database.<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'port'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The port on which to connect to the database.<br> *<br> * The table structure is as follows:<br> *<br> *&nbsp;&nbsp;create table nag_tasks (<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_owner&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(32) not null,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int not null,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(64) not null,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_desc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text null,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_added&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int not null,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_due&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int null,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_priority&nbsp;&nbsp;&nbsp;int null default 0,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task_depends&nbsp;&nbsp;&nbsp;&nbsp;int null default -1,<br> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;primary key (task_owner, task_id)<br> *&nbsp;&nbsp;);<br> *<br> * @author&nbsp;&nbsp;Jon Parise &lt;jon@horde.org&gt;<br> * @version $Revision: 1.1 $<br> * @since&nbsp;&nbsp;&nbsp;Nag 0.1<br> * @package nag<br> */<br></font><font color="#007700">class&nbsp;</font><font color="#0000BB">Nag_Storage_sql&nbsp;</font><font color="#007700">extends&nbsp;</font><font color="#0000BB">Nag_Storage&nbsp;</font><font color="#007700">{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/** Hash containing connection parameters. */<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">var&nbsp;</font><font color="#0000BB">$params&nbsp;</font><font color="#007700">=&nbsp;array();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/** Handle for the current database connection.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@var object DB $db */<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">var&nbsp;</font><font color="#0000BB">$db</font><font color="#007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/** Boolean indicating whether or not we're connected to the SQL server. */<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">var&nbsp;</font><font color="#0000BB">$connected&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">false</font><font color="#007700">;<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Constructs a new SQL preferences object.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @param string $user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The user who owns these preferences.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @param string $password&nbsp;&nbsp;The password associated with $user. (unused)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @param string $scope&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The current preferences scope.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @param array&nbsp;&nbsp;$params&nbsp;&nbsp;&nbsp;&nbsp;A hash containing connection parameters.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">function&nbsp;</font><font color="#0000BB">Nag_Storage_sql</font><font color="#007700">(</font><font color="#0000BB">$user</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$params&nbsp;</font><font color="#007700">=&nbsp;array())<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">user&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$user</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$params</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Attempts to open a persistent connection to the SQL server.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @return int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STORAGE_OK on success, STORAGE_ERROR_* on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">function&nbsp;</font><font color="#0000BB">connect</font><font color="#007700">()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connected</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include_once&nbsp;</font><font color="#DD0000">'DB.php'</font><font color="#007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</font><font color="#0000BB">is_array</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'phptype'</font><font color="#007700">]))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'hostspec'</font><font color="#007700">]))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'username'</font><font color="#007700">]))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'password'</font><font color="#007700">]))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'database'</font><font color="#007700">]))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'table'</font><font color="#007700">]))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_PARAMS</font><font color="#007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Connect to the SQL server using the supplied parameters. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db&nbsp;</font><font color="#007700">=&nbsp;&amp;</font><font color="#0000BB">DB</font><font color="#007700">::</font><font color="#0000BB">connect</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">,&nbsp;</font><font color="#0000BB">true</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</font><font color="#0000BB">DB</font><font color="#007700">::</font><font color="#0000BB">isError</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">)&nbsp;||&nbsp;</font><font color="#0000BB">DB</font><font color="#007700">::</font><font color="#0000BB">isWarning</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_CONNECT</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connected&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">true</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_OK</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Disconnect from the SQL server and clean up the connection.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @return boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true on success, false on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">function&nbsp;</font><font color="#0000BB">disconnect</font><font color="#007700">()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connected</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connected&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">false</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">disconnect</font><font color="#007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">true</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Retrieves the user's tasks from the database.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @return int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STORAGE_OK on success, or STORAGE_ERROR_* on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">function&nbsp;</font><font color="#0000BB">retrieve</font><font color="#007700">()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* If we're not already connected, invoke the connect() method now. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(!</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connected</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connect</font><font color="#007700">()&nbsp;!=&nbsp;</font><font color="#0000BB">STORAGE_OK</font><font color="#007700">)&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_CONNECT</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Build the SQL query. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'select * from %s where task_owner = %s'</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'table'</font><font color="#007700">],&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">user</font><font color="#007700">));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Execute the query. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">query</font><font color="#007700">(</font><font color="#0000BB">$query</font><font color="#007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset(</font><font color="#0000BB">$result</font><font color="#007700">)&nbsp;&amp;&amp;&nbsp;!</font><font color="#0000BB">DB</font><font color="#007700">::</font><font color="#0000BB">isError</font><font color="#007700">(</font><font color="#0000BB">$result</font><font color="#007700">))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$row&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$result</font><font color="#007700">-&gt;</font><font color="#0000BB">fetchRow</font><font color="#007700">(</font><font color="#0000BB">DB_FETCHMODE_ASSOC</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</font><font color="#0000BB">DB</font><font color="#007700">::</font><font color="#0000BB">isError</font><font color="#007700">(</font><font color="#0000BB">$row</font><font color="#007700">))&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_EMPTY</font><font color="#007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Store the retrieved values in a fresh $tasks list. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">tasks&nbsp;</font><font color="#007700">=&nbsp;array();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</font><font color="#0000BB">$row&nbsp;</font><font color="#007700">&amp;&amp;&nbsp;!</font><font color="#0000BB">DB</font><font color="#007700">::</font><font color="#0000BB">isError</font><font color="#007700">(</font><font color="#0000BB">$row</font><font color="#007700">))&nbsp;{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Create a new task based on this row's values. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task&nbsp;</font><font color="#007700">=&nbsp;array();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'name'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_name'</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'desc'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_desc'</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'added'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_added'</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'due'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_due'</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'priority'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_priority'</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'depends'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_depends'</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'flags'</font><font color="#007700">]&nbsp;=&nbsp;</font><font color="#0000BB">0</font><font color="#007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Add this new task to the $tasks list. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">tasks</font><font color="#007700">[(</font><font color="#0000BB">$row</font><font color="#007700">[</font><font color="#DD0000">'task_id'</font><font color="#007700">])]&nbsp;=&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Advance to the new row in the result set. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$row&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$result</font><font color="#007700">-&gt;</font><font color="#0000BB">fetchRow</font><font color="#007700">(</font><font color="#0000BB">DB_FETCHMODE_ASSOC</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$result</font><font color="#007700">-&gt;</font><font color="#0000BB">free</font><font color="#007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_OK</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Stores the user's tasks to SQL server.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* @return int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STORAGE_OK on success, or STORAGE_ERROR_* on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">function&nbsp;</font><font color="#0000BB">store</font><font color="#007700">()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Build lists of the tasks that require pending database operations. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$added_tasks&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">listTasks</font><font color="#007700">(</font><font color="#0000BB">TASK_ADDED</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$modified_tasks&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">listTasks</font><font color="#007700">(</font><font color="#0000BB">TASK_MODIFIED</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$deleted_tasks&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">listTasks</font><font color="#007700">(</font><font color="#0000BB">TASK_DELETED</font><font color="#007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* If there are no pending operations, exit successfully now. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;((</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$added_tasks</font><font color="#007700">)&nbsp;==&nbsp;</font><font color="#0000BB">0</font><font color="#007700">)&nbsp;&amp;&amp;&nbsp;(</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$modified_tasks</font><font color="#007700">)&nbsp;==&nbsp;</font><font color="#0000BB">0</font><font color="#007700">)&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$deleted_tasks</font><font color="#007700">)&nbsp;==&nbsp;</font><font color="#0000BB">0</font><font color="#007700">))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_OK</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* If we're not already connected, invoke the connect() method now. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(!</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connected</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">connect</font><font color="#007700">()&nbsp;!=&nbsp;</font><font color="#0000BB">STORAGE_OK</font><font color="#007700">)&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR_CONNECT</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Perform any pending additions. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$added_tasks</font><font color="#007700">)&nbsp;&gt;&nbsp;</font><font color="#0000BB">0</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(</font><font color="#0000BB">$added_tasks&nbsp;</font><font color="#007700">as&nbsp;</font><font color="#0000BB">$task_id&nbsp;</font><font color="#007700">=&gt;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#DD0000">'insert into %s (task_owner, task_id, task_name, '&nbsp;</font><font color="#007700">.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#DD0000">'task_desc, task_added, task_due, task_priority, '&nbsp;</font><font color="#007700">.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#DD0000">'task_depends) '&nbsp;</font><font color="#007700">.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#DD0000">'values(%s, %d, %s, %s, %d, %d, %d, %d)'</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'table'</font><font color="#007700">],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">user</font><font color="#007700">),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task_id</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'name'</font><font color="#007700">]),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'desc'</font><font color="#007700">]),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'added'</font><font color="#007700">],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'due'</font><font color="#007700">],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'priority'</font><font color="#007700">],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'depends'</font><font color="#007700">]);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Attempt the insertion query. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">query</font><font color="#007700">(</font><font color="#0000BB">$query</font><font color="#007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Return an error immediately if the query failed. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">!==&nbsp;</font><font color="#0000BB">DB_OK</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Remove the "added" flag from this task. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">setFlag</font><font color="#007700">(</font><font color="#0000BB">$task_id</font><font color="#007700">,&nbsp;</font><font color="#0000BB">TASK_ADDED</font><font color="#007700">,&nbsp;</font><font color="#0000BB">false</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Perform any pending modifications. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$modified_tasks</font><font color="#007700">)&nbsp;&gt;&nbsp;</font><font color="#0000BB">0</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(</font><font color="#0000BB">$modified_tasks&nbsp;</font><font color="#007700">as&nbsp;</font><font color="#0000BB">$task_id&nbsp;</font><font color="#007700">=&gt;&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'update %s set '</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'table'</font><font color="#007700">]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'task_name = %s, '</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'name'</font><font color="#007700">]));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'task_desc = %s, '</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'desc'</font><font color="#007700">]));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'task_added = %d, '</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'added'</font><font color="#007700">]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'task_due = %d, '</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'due'</font><font color="#007700">]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'task_priority = %d, '</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'priority'</font><font color="#007700">]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'task_depends = %d '</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$task</font><font color="#007700">[</font><font color="#DD0000">'depends'</font><font color="#007700">]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'where task_owner = %s and task_id = %d'</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">quote</font><font color="#007700">(</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">user</font><font color="#007700">),&nbsp;</font><font color="#0000BB">$task_id</font><font color="#007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Attempt the update query. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">query</font><font color="#007700">(</font><font color="#0000BB">$query</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Return an error immediately if the query failed. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">!==&nbsp;</font><font color="#0000BB">DB_OK</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Remove the "modified" flag from this task. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">setFlag</font><font color="#007700">(</font><font color="#0000BB">$task_id</font><font color="#007700">,&nbsp;</font><font color="#0000BB">TASK_MODIFIED</font><font color="#007700">,&nbsp;</font><font color="#0000BB">false</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Perform any pending deletions. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$deleted_tasks</font><font color="#007700">)&nbsp;&gt;&nbsp;</font><font color="#0000BB">0</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$task_ids&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">array_keys</font><font color="#007700">(</font><font color="#0000BB">$deleted_tasks</font><font color="#007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$where&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#DD0000">'task_id = '&nbsp;</font><font color="#007700">.&nbsp;</font><font color="#0000BB">$task_ids</font><font color="#007700">[</font><font color="#0000BB">0</font><font color="#007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</font><font color="#0000BB">count</font><font color="#007700">(</font><font color="#0000BB">$task_ids</font><font color="#007700">)&nbsp;&gt;&nbsp;</font><font color="#0000BB">1</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">array_shift</font><font color="#007700">(</font><font color="#0000BB">$task_ids</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$where&nbsp;</font><font color="#007700">.=&nbsp;</font><font color="#DD0000">' or task_id = '&nbsp;</font><font color="#007700">.&nbsp;</font><font color="#0000BB">implode</font><font color="#007700">(</font><font color="#DD0000">' or task_id ='</font><font color="#007700">,&nbsp;</font><font color="#0000BB">$task_ids</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$query&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">sprintf</font><font color="#007700">(</font><font color="#DD0000">'delete from %s where %s'</font><font color="#007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">params</font><font color="#007700">[</font><font color="#DD0000">'table'</font><font color="#007700">],&nbsp;</font><font color="#0000BB">$where</font><font color="#007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Attempt the delete query. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">=&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">db</font><font color="#007700">-&gt;</font><font color="#0000BB">query</font><font color="#007700">(</font><font color="#0000BB">$query</font><font color="#007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Return an error immediately if the query failed. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#007700">if&nbsp;(</font><font color="#0000BB">$result&nbsp;</font><font color="#007700">!==&nbsp;</font><font color="#0000BB">DB_OK</font><font color="#007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_ERROR</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">/* Purge the deleted tasks. */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$this</font><font color="#007700">-&gt;</font><font color="#0000BB">purgeDeleted</font><font color="#007700">();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</font><font color="#0000BB">STORAGE_OK</font><font color="#007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></font><font color="#0000BB">?&gt;<br></font>
</font>
</code><br />


</td></tr></table></div>
</body>
</html>
