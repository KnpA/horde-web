<div class="document" id="upgrading-horde">
<h1 class="title">Upgrading Horde</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Contact:</th>
<td><a class="first last reference external" href="mailto:horde&#64;lists.horde.org">horde&#64;lists.horde.org</a></td></tr>
</tbody>
</table>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#general-instructions" id="id4">1&nbsp;&nbsp;&nbsp;General instructions</a></li>
<li><a class="reference internal" href="#upgrading-horde-from-4-0-to-4-0-1" id="id5">2&nbsp;&nbsp;&nbsp;Upgrading Horde from 4.0 to 4.0.1</a><ul class="auto-toc">
<li><a class="reference internal" href="#configuration-values" id="id6">2.1&nbsp;&nbsp;&nbsp;Configuration Values</a></li>
<li><a class="reference internal" href="#hooks" id="id7">2.2&nbsp;&nbsp;&nbsp;Hooks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading-horde-from-3-3-x-to-4-x" id="id8">3&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.3.x to 4.x</a><ul class="auto-toc">
<li><a class="reference internal" href="#new-installation-method" id="id9">3.1&nbsp;&nbsp;&nbsp;New installation method</a></li>
<li><a class="reference internal" href="#new-configuration-scheme" id="id10">3.2&nbsp;&nbsp;&nbsp;New configuration scheme</a></li>
<li><a class="reference internal" href="#new-database-migrations" id="id11">3.3&nbsp;&nbsp;&nbsp;New database migrations</a></li>
<li><a class="reference internal" href="#postgresql" id="id12">3.4&nbsp;&nbsp;&nbsp;PostgreSQL</a></li>
<li><a class="reference internal" href="#configuration-changes" id="id13">3.5&nbsp;&nbsp;&nbsp;Configuration changes</a></li>
<li><a class="reference internal" href="#preferences" id="id14">3.6&nbsp;&nbsp;&nbsp;Preferences</a></li>
<li><a class="reference internal" href="#id1" id="id15">3.7&nbsp;&nbsp;&nbsp;Hooks</a></li>
<li><a class="reference internal" href="#alarms" id="id16">3.8&nbsp;&nbsp;&nbsp;Alarms</a></li>
<li><a class="reference internal" href="#groups" id="id17">3.9&nbsp;&nbsp;&nbsp;Groups</a></li>
<li><a class="reference internal" href="#pear-packages" id="id18">3.10&nbsp;&nbsp;&nbsp;PEAR packages</a></li>
<li><a class="reference internal" href="#removed-features" id="id19">3.11&nbsp;&nbsp;&nbsp;Removed features</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading-horde-from-3-3-x-to-3-3-5" id="id20">4&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.3.x to 3.3.5</a></li>
<li><a class="reference internal" href="#upgrading-horde-from-3-2-x-to-3-3-x" id="id21">5&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.2.x to 3.3.x</a></li>
<li><a class="reference internal" href="#upgrading-horde-from-3-1-x-to-3-2-x" id="id22">6&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.1.x to 3.2.x</a><ul class="auto-toc">
<li><a class="reference internal" href="#sql-backends" id="id23">6.1&nbsp;&nbsp;&nbsp;SQL Backends</a></li>
<li><a class="reference internal" href="#beta-sql-drivers" id="id24">6.2&nbsp;&nbsp;&nbsp;Beta SQL Drivers</a></li>
<li><a class="reference internal" href="#memcache-configuration" id="id25">6.3&nbsp;&nbsp;&nbsp;Memcache Configuration</a></li>
<li><a class="reference internal" href="#application-hooks" id="id26">6.4&nbsp;&nbsp;&nbsp;Application Hooks</a></li>
<li><a class="reference internal" href="#group-hooks" id="id27">6.5&nbsp;&nbsp;&nbsp;Group Hooks</a></li>
<li><a class="reference internal" href="#custom-themes" id="id28">6.6&nbsp;&nbsp;&nbsp;Custom Themes</a></li>
<li><a class="reference internal" href="#static-log-out-links" id="id29">6.7&nbsp;&nbsp;&nbsp;Static Log out Links</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading-horde-from-3-1-1-to-3-1-2" id="id30">7&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.1.1 to 3.1.2</a><ul class="auto-toc">
<li><a class="reference internal" href="#session-configuration" id="id31">7.1&nbsp;&nbsp;&nbsp;Session Configuration</a></li>
<li><a class="reference internal" href="#additional-indexes-for-the-preference-table" id="id32">7.2&nbsp;&nbsp;&nbsp;Additional Indexes for the Preference Table</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading-horde-from-3-1-to-3-1-1" id="id33">8&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.1 to 3.1.1</a><ul class="auto-toc">
<li><a class="reference internal" href="#mysql-session-handler" id="id34">8.1&nbsp;&nbsp;&nbsp;MySQL Session Handler</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading-horde-from-3-0-x-to-3-1-x" id="id35">9&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.0.x to 3.1.x</a><ul class="auto-toc">
<li><a class="reference internal" href="#id2" id="id36">9.1&nbsp;&nbsp;&nbsp;SQL Backends</a></li>
<li><a class="reference internal" href="#id3" id="id37">9.2&nbsp;&nbsp;&nbsp;Groups</a></li>
<li><a class="reference internal" href="#history" id="id38">9.3&nbsp;&nbsp;&nbsp;History</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general-instructions">
<h1><a class="toc-backref" href="#id4">1&nbsp;&nbsp;&nbsp;General instructions</a></h1>
<p>These are instructions to upgrade from earlier Horde versions. Please backup
your existing data before running any of the steps described below. You can't
use the updated data with your old Horde version anymore.</p>
<p>Upgrading Horde (and all installed Horde libraries and applications)
is as easy as running:</p>
<pre class="literal-block">
pear upgrade -a -B -c horde
</pre>
<p>If you want to upgrade from a Horde version prior to 4.0, please
follow the instructions in <a class="reference external" href="INSTALL">INSTALL</a> to install the most recent Horde
version using the PEAR installer.</p>
<p>After updating to a newer Horde version, or a newer version of <strong>any</strong> Horde
application, you <strong>always</strong> need to update configurations and database
schemes. Log in as an administrator, go to Administration =&gt; Configuration and
update anything that's highlighted as outdated.</p>
</div>
<div class="section" id="upgrading-horde-from-4-0-to-4-0-1">
<h1><a class="toc-backref" href="#id5">2&nbsp;&nbsp;&nbsp;Upgrading Horde from 4.0 to 4.0.1</a></h1>
<div class="section" id="configuration-values">
<h2><a class="toc-backref" href="#id6">2.1&nbsp;&nbsp;&nbsp;Configuration Values</a></h2>
<dl class="docutils">
<dt>Cyrsql driver: The 'unixhier' parameter has been replaced by the</dt>
<dd>'userhierarchy' parameter.</dd>
</dl>
</div>
<div class="section" id="hooks">
<h2><a class="toc-backref" href="#id7">2.2&nbsp;&nbsp;&nbsp;Hooks</a></h2>
<p>The appinitialized hook was added.  See <tt class="docutils literal">config/hooks.php.dist</tt> for more
details on this hook.</p>
</div>
</div>
<div class="section" id="upgrading-horde-from-3-3-x-to-4-x">
<h1><a class="toc-backref" href="#id8">3&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.3.x to 4.x</a></h1>
<div class="section" id="new-installation-method">
<h2><a class="toc-backref" href="#id9">3.1&nbsp;&nbsp;&nbsp;New installation method</a></h2>
<p>Since Horde 4 the supported installation method has been changed to
install Horde and all dependencies through the PEAR installer. See
<a class="reference external" href="INSTALL">INSTALL</a> for instructions how to install Horde through PEAR.</p>
<p>Existing <strong>data</strong> from the latest Horde can be migrated from the
configuration screen in the administration section. It is recommended
to re-create the <strong>configuration</strong> from scratch though.</p>
</div>
<div class="section" id="new-configuration-scheme">
<h2><a class="toc-backref" href="#id10">3.2&nbsp;&nbsp;&nbsp;New configuration scheme</a></h2>
<p>With Horde 4 it is no longer necessary to create any configuration files
besides <tt class="docutils literal">conf.php</tt> files. The default configuration files in the <tt class="docutils literal">config/</tt>
directory should work for most systems. If some changes in those files are
necessary, <strong>DON'T EDIT THE FILES DIRECTLY or your CHANGES WILL BE LOST with
the next upgrade</strong>. Create <tt class="docutils literal">*.local.php</tt> files instead and only add
configuration settings that you want to change from the default values
there. See the header of the configuration files for details and examples.</p>
<p><tt class="docutils literal">conf.php</tt> files are still created and updated as usual through the
configuration interface.</p>
</div>
<div class="section" id="new-database-migrations">
<h2><a class="toc-backref" href="#id11">3.3&nbsp;&nbsp;&nbsp;New database migrations</a></h2>
<p>With Horde 4 database updates are no longer done by running SQL scripts through
your database server's console or web frontend. A migration framework has been
created instead that can be used through the web interface and a command line
script.</p>
<p>After updating, log in to Horde as an adminstrator, make sure that all
configurations are up-to-date, then click on the <tt class="docutils literal">Update all DB schemas</tt>
button. You can also update the database schemas individually if necessary.</p>
<p>Alternatively there is a command line script <tt class="docutils literal"><span class="pre">horde-db-migrate</span></tt> that can be
used for upgrading the database schemas. Call it without any parameters to
upgrade schemas for all installed applications and components, or specify the
application, component, or <tt class="docutils literal">migration/</tt> directory that you want to upgrade
individually.</p>
</div>
<div class="section" id="postgresql">
<h2><a class="toc-backref" href="#id12">3.4&nbsp;&nbsp;&nbsp;PostgreSQL</a></h2>
<p>If using PostgreSQL, you must upgrade the value column of the preference table
from TEXT to BYTEA <strong>before</strong> running any other upgrade tasks. The necessary
SQL statement is found at:</p>
<pre class="literal-block">
scripts/upgrades/2009-04-13_horde_pgsql_upgrade.sql
</pre>
</div>
<div class="section" id="configuration-changes">
<h2><a class="toc-backref" href="#id13">3.5&nbsp;&nbsp;&nbsp;Configuration changes</a></h2>
<p>Many configuration names and values have changed. It is suggested that you
start with a fresh configuration instead of trying to import some existing
configuration from Horde 3.</p>
</div>
<div class="section" id="preferences">
<h2><a class="toc-backref" href="#id14">3.6&nbsp;&nbsp;&nbsp;Preferences</a></h2>
<p>The following preferences are no longer used and can be removed from the
horde_prefs table if you want to save database storage:</p>
<blockquote>
<ul class="simple">
<li>confirm_maintenance</li>
<li>do_maintenance</li>
<li>editor_plugins</li>
<li>last_maintenance</li>
</ul>
</blockquote>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id15">3.7&nbsp;&nbsp;&nbsp;Hooks</a></h2>
<p>The hooks format has been changed completely. <tt class="docutils literal">hooks.php</tt> no longer contains
separate functions for each hook, but a single class with separate methods for
each hook. Please take a look at the new examples in <tt class="docutils literal">hooks.php.dist</tt> before
porting any hooks to Horde 4. Some hook signatures have changed, some hooks
have been renamed, removed or added.</p>
<p>Noteably the following hooks have changed:</p>
<blockquote>
<ul class="simple">
<li>&quot;preauthenticate&quot; (Parameters and return value have changed)</li>
<li>&quot;postauthenticate&quot; (Parameters and return value have changed)</li>
<li>&quot;username_tobackend&quot;, &quot;username_frombackend&quot; (Have been combined and
renamed to &quot;authusername&quot;)</li>
<li>There are only two methods prefs_init() and prefs_change() for all
preferences.</li>
</ul>
</blockquote>
</div>
<div class="section" id="alarms">
<h2><a class="toc-backref" href="#id16">3.8&nbsp;&nbsp;&nbsp;Alarms</a></h2>
<p>The alarm system is using UTC dates now. This can cause problems for a short
time after updating to Horde and before the alarms have been refreshed. To
avoid any problems you should empty the horde_alarms table after upgrading
manually. This SQL query should work:</p>
<pre class="literal-block">
DELETE FROM horde_alarms
</pre>
<p>The script to generate alarm notifications through a cron job
(<tt class="docutils literal">scripts/alarms.php</tt>) has been renamed and is installed to a different
location when using the PEAR installation method. The new name is
<tt class="docutils literal"><span class="pre">bin/horde-alarms</span></tt> and it will be installed to <tt class="docutils literal"><span class="pre">/usr/bin/horde-alarms</span></tt> by
default. Update your cron jobs accordingly.</p>
</div>
<div class="section" id="groups">
<h2><a class="toc-backref" href="#id17">3.9&nbsp;&nbsp;&nbsp;Groups</a></h2>
<p>The groups system has been rewritten. Group hierarchies, i.e. parent and child
groups are no longer supported. Support for nested groups will be added at a
later point.</p>
</div>
<div class="section" id="pear-packages">
<h2><a class="toc-backref" href="#id18">3.10&nbsp;&nbsp;&nbsp;PEAR packages</a></h2>
<p>The Crypt_Blowfish package is required now. If you installed Horde using the
PEAR installer, it will be installed automatically though.</p>
</div>
<div class="section" id="removed-features">
<h2><a class="toc-backref" href="#id19">3.11&nbsp;&nbsp;&nbsp;Removed features</a></h2>
<ul class="simple">
<li>Database abstraction has been moved to a new Horde_Db component. Any database
support beside MySQL (native and PDO), PostgreSQL, and SQLite have been
removed. If you need support for any other RDBMS, consider sponsoring the
development of new drivers for that system.</li>
<li>DataTree support has been removed. Several systems used DataTree as a
possible backend for historical reasons. If you still used DataTree backends
in Horde 3 and didn't migrate to SQL drivers yet, now you have to. See
further below for instructions how to migrate away from DataTree backends.</li>
<li>The krb5 authentication driver has been removed.</li>
<li>The LDAP session handler has been removed.</li>
<li>The enscript and webcpp MIME Viewers have been replaced by the
'Syntaxhighlighter' driver.</li>
</ul>
</div>
</div>
<div class="section" id="upgrading-horde-from-3-3-x-to-3-3-5">
<h1><a class="toc-backref" href="#id20">4&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.3.x to 3.3.5</a></h1>
<p>The signup_email column of the horde_signups table is no longer needed. You
can execute the provide SQL script to remove that column, e.g.:</p>
<pre class="literal-block">
mysql --user=root --password=&lt;MySQL-root-password&gt; &lt;db name&gt; &lt; scripts/upgrades/3.3_to_3.3.5.sql
</pre>
</div>
<div class="section" id="upgrading-horde-from-3-2-x-to-3-3-x">
<h1><a class="toc-backref" href="#id21">5&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.2.x to 3.3.x</a></h1>
<p>The sequence name for the SQL share driver has been changed from 'sequence' to
'id' You must execute the provided PHP script to update your database:</p>
<pre class="literal-block">
php scripts/upgrades/2008-08-29_fix_mdb2_sequences.php
</pre>
<p>Note that this upgrade will require you to have the PEAR MDB2_Schema package
installed on your system:</p>
<pre class="literal-block">
pear install MDB2_Schema
</pre>
</div>
<div class="section" id="upgrading-horde-from-3-1-x-to-3-2-x">
<h1><a class="toc-backref" href="#id22">6&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.1.x to 3.2.x</a></h1>
<div class="section" id="sql-backends">
<h2><a class="toc-backref" href="#id23">6.1&nbsp;&nbsp;&nbsp;SQL Backends</a></h2>
<p>A few new tables have been added to Horde.</p>
<p>Execute one of the provided SQL scripts to update your data to the new Horde
version, e.g.:</p>
<pre class="literal-block">
mysql --user=root --password=&lt;MySQL-root-password&gt; &lt;db name&gt; &lt; scripts/upgrades/3.1_to_3.2.mysql.sql
</pre>
</div>
<div class="section" id="beta-sql-drivers">
<h2><a class="toc-backref" href="#id24">6.2&nbsp;&nbsp;&nbsp;Beta SQL Drivers</a></h2>
<p>There are now beta-level SQL drivers for Groups, Shares, and Permissions. There
is a script <tt class="docutils literal"><span class="pre">horde-convert-datatree-perms-to-sql</span></tt> that will migrate all of
your DataTree-based permissions to the SQL backend, and
<tt class="docutils literal"><span class="pre">horde-convert-datatree-groups-to-sql</span></tt> that will migrate groups. For shares,
you will need to upgrade each application individually. Applications that use
shares have entries in <tt class="docutils literal">docs/UPGRADING</tt> and upgrade scripts
<tt class="docutils literal"><span class="pre">app-convert-datatree-shares-to-sql</span></tt> for creating the SQL share tables and
migrating data.</p>
<p>The SQL drivers should perform much better than the DataTree versions,
but they have not received the same level of testing, thus the beta
designation.</p>
</div>
<div class="section" id="memcache-configuration">
<h2><a class="toc-backref" href="#id25">6.3&nbsp;&nbsp;&nbsp;Memcache Configuration</a></h2>
<p>All memcache configuration has been moved to the $conf['memcache'] parameter.</p>
</div>
<div class="section" id="application-hooks">
<h2><a class="toc-backref" href="#id26">6.4&nbsp;&nbsp;&nbsp;Application Hooks</a></h2>
<p>All hooks that are specific to a single application have been moved to that
application's <tt class="docutils literal">config/hooks.php</tt> file. Split up your existing Hooks from
<tt class="docutils literal">horde/config/hooks.php</tt> and move them to the correct application.</p>
</div>
<div class="section" id="group-hooks">
<h2><a class="toc-backref" href="#id27">6.5&nbsp;&nbsp;&nbsp;Group Hooks</a></h2>
<p>The format for group hook functions has changed from
_group_hook_groupName($username) to _group_hook($groupName,
$userName).  So you will need to modify any existing group hook
functions in config/hooks.php for the new interface.</p>
<p>Alternatively, an example _group_hook() function is provided in
config/hooks.php that will call the old style hook functions for you.</p>
</div>
<div class="section" id="custom-themes">
<h2><a class="toc-backref" href="#id28">6.6&nbsp;&nbsp;&nbsp;Custom Themes</a></h2>
<p>Themes only have a single <tt class="docutils literal">info.php</tt> file with the theme name in Horde's
<tt class="docutils literal">themes</tt> directory now. If you have any custom themes that provide their own
images, you must add a <tt class="docutils literal">themed_graphics</tt> file to the theme's directory (for
all applications the theme provides images for) in order for Horde to know to
use the custom images. The file can be empty or contain whatever you wish; it
simply needs to exist.</p>
</div>
<div class="section" id="static-log-out-links">
<h2><a class="toc-backref" href="#id29">6.7&nbsp;&nbsp;&nbsp;Static Log out Links</a></h2>
<p>If you have hardcoded a log out link in any custom templates or menu
items, you must update it to use Horde::getServiceLink(). This is
because logging out is now protected by a token to avoid CSRF
exploits.</p>
</div>
</div>
<div class="section" id="upgrading-horde-from-3-1-1-to-3-1-2">
<h1><a class="toc-backref" href="#id30">7&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.1.1 to 3.1.2</a></h1>
<div class="section" id="session-configuration">
<h2><a class="toc-backref" href="#id31">7.1&nbsp;&nbsp;&nbsp;Session Configuration</a></h2>
<p>A new configuration setting has been added to disable GET-based
sessions.  If this setting is enabled, session IDs will only be stored
in session cookies, requiring the users to enable cookies in their
browser and the cookie settings in Horde's configuration to be correct.</p>
<p>Using session cookies is much safer since no session information can
be stored in any web server or proxy log files, referrer headers,
browser caches, or browser bookmarks.</p>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">This setting in enabled by default.</p>
</div>
</div>
<div class="section" id="additional-indexes-for-the-preference-table">
<h2><a class="toc-backref" href="#id32">7.2&nbsp;&nbsp;&nbsp;Additional Indexes for the Preference Table</a></h2>
<p>Optionally execute the provided SQL script 2006-06-29_horde_prefs_indexes.sql
to create two additional indexes in the preference table, e.g.:</p>
<pre class="literal-block">
mysql --user=root --password=&lt;MySQL-root-password&gt; &lt;db name&gt; &lt; scripts/upgrades/2006-06-29_horde_prefs_indexes.sql
</pre>
<p>This increases database performance for some database systems, e.g. PostgreSQL
if you have large preference tables.</p>
</div>
</div>
<div class="section" id="upgrading-horde-from-3-1-to-3-1-1">
<h1><a class="toc-backref" href="#id33">8&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.1 to 3.1.1</a></h1>
<div class="section" id="mysql-session-handler">
<h2><a class="toc-backref" href="#id34">8.1&nbsp;&nbsp;&nbsp;MySQL Session Handler</a></h2>
<p>The mysql session handler has been improved to correctly lock concurrent
accesses to the same session. You need to set in the Horde configuration if
you want to use row-level locking and transactions or table-level
locking. Row-level locking and transactions are only supported by some table
engines like InnoDB, and is recommended for session tables. The default table
type for MySQL is MyISAM though, that only supports table-level locking. If
you used the SQL scripts from Horde 3.1 or earlier to create the session
table, this is probably the current engine of you session table. If you want
to change the table type to InnoDB, execute the following SQL statement:</p>
<pre class="literal-block">
ALTER TABLE horde_sessionhandler ENGINE = InnoDB
</pre>
</div>
</div>
<div class="section" id="upgrading-horde-from-3-0-x-to-3-1-x">
<h1><a class="toc-backref" href="#id35">9&nbsp;&nbsp;&nbsp;Upgrading Horde from 3.0.x to 3.1.x</a></h1>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id36">9.1&nbsp;&nbsp;&nbsp;SQL Backends</a></h2>
<p>A few new tables have been added to Horde.</p>
<p>Execute one of the provided SQL scripts to update your data to the new Horde
version, e.g.:</p>
<pre class="literal-block">
mysql --user=root --password=&lt;MySQL-root-password&gt; &lt;db name&gt; &lt; scripts/upgrades/3.0_to_3.1.mysql.sql
</pre>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id37">9.2&nbsp;&nbsp;&nbsp;Groups</a></h2>
<p>The Horde_Group API uses group IDs instead of group names to avoid ambiguity.
Be sure to update any custom code that uses Horde_Group.</p>
</div>
<div class="section" id="history">
<h2><a class="toc-backref" href="#id38">9.3&nbsp;&nbsp;&nbsp;History</a></h2>
<p>The Horde_History storage has been moved out to a separate database table to
drastically improve performance.</p>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">Migration of the Horde_History data may take a very long time,
possibly days, depending on the number of entries.  Be sure to
execute this script from a location where it will not be timed
out by firewall or terminal timeouts.</p>
</div>
<p>Execute the provided PHP script to migrate your histories to the new table:</p>
<pre class="literal-block">
horde-move-history-out-of-datatree
</pre>
</div>
</div>
</div>
